services:
  # Kong Gateway in DB-less, Read-Only Mode
  kong-gateway:
    image: kong/kong-gateway:3.13.0.0
    container_name: kong-gateway-readonly
    hostname: kong-gateway
    restart: unless-stopped

    # Enable read-only filesystem for security
    read_only: true

    # Network configuration
    networks:
      - kong-net

    # Port mappings
    ports:
      - "8000:8000"   # Proxy HTTP
      - "8443:8443"   # Proxy HTTPS
      - "8001:8001"   # Admin API HTTP
      - "8002:8002"   # Admin GUI HTTP
      - "8003:8003"   # Admin GUI HTTPS
      - "8004:8004"   # Portal HTTP
      - "8005:8005"   # Portal HTTPS
      - "8006:8006"   # Portal API HTTP
      - "8007:8007"   # Portal API HTTPS
      - "9080:9080"   # Prometheus metrics

    # Environment variables
    environment:
      # Database configuration (DB-less mode)
      KONG_DATABASE: 'off'
      KONG_DECLARATIVE_CONFIG: '/kong/declarative/kong.yml'

      # Prefix directory for Kong runtime
      KONG_PREFIX: '/var/run/kong'

      # Proxy configuration
      KONG_PROXY_LISTEN: '0.0.0.0:8000, 0.0.0.0:8443 ssl'
      KONG_PROXY_ACCESS_LOG: '/dev/stdout'
      KONG_PROXY_ERROR_LOG: '/dev/stderr'

      # Admin API configuration
      KONG_ADMIN_LISTEN: '0.0.0.0:8001, 0.0.0.0:8444 ssl'
      KONG_ADMIN_ACCESS_LOG: '/dev/stdout'
      KONG_ADMIN_ERROR_LOG: '/dev/stderr'
      KONG_ADMIN_GUI_LISTEN: '0.0.0.0:8002, 0.0.0.0:8445 ssl'

      # Portal configuration (Enterprise only)
      KONG_PORTAL: 'on'
      KONG_PORTAL_GUI_PROTOCOL: 'http'
      KONG_PORTAL_GUI_HOST: 'localhost:8003'

      # Logging
      KONG_LOG_LEVEL: 'info'

      # DNS resolver (for upstream health checks)
      KONG_DNS_ORDER: 'LAST,A,CNAME'

      # Nginx settings for better performance
      KONG_NGINX_WORKER_PROCESSES: '2'
      KONG_NGINX_HTTP_CLIENT_BODY_BUFFER_SIZE: '16k'
      KONG_NGINX_HTTP_CLIENT_MAX_BODY_SIZE: '10m'

      # Enable Prometheus plugin
      KONG_PLUGINS: 'bundled'
      KONG_STATUS_LISTEN: '0.0.0.0:9080'

      # Real IP configuration (if behind reverse proxy)
      KONG_REAL_IP_HEADER: 'X-Forwarded-For'
      KONG_TRUSTED_IPS: '0.0.0.0/0,::/0'

      # Misc
      KONG_ANONYMOUS_REPORTS: 'off'

    # Volume mounts (required for read-only mode)
    volumes:
      # Declarative configuration
      - ./declarative:/kong/declarative:ro

      # Temporary directory (writable)
      - ./tmp_volume:/tmp

      # Kong prefix directory (writable)
      - ./prefix_volume:/var/run/kong

    # Health check
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Security options
    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

networks:
  kong-net:
    driver: bridge
    name: kong-network
