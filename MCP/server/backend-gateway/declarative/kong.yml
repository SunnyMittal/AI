_format_version: "3.0"
_transform: true

# Services define upstream backend applications
services:
  # Python Calculator MCP Server (Connected to Upstream)
  - name: py-calculator
    host: py-calculator-upstream  # Using upstream for health checks and load balancing
    protocol: http
    port: 80  # Port handled by upstream targets
    tags:
      - mcp
      - calculator
      - python
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: py-calculator-route
        paths:
          - /py-calculator
        strip_path: true
        preserve_host: true
        protocols:
          - http
          - https
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        tags:
          - mcp
          - calculator

  # Go Calculator MCP Server (Connected to Upstream)
  - name: go-calculator
    host: go-calculator-upstream  # Using upstream for health checks and load balancing
    protocol: http
    port: 80  # Port handled by upstream targets
    tags:
      - mcp
      - calculator
      - golang
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: go-calculator-route
        paths:
          - /go-calculator
        strip_path: true
        preserve_host: true
        protocols:
          - http
          - https
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        tags:
          - mcp
          - calculator

  # Arize Phoenix Observability Platform
  - name: phoenix
    url: http://host.docker.internal:6006
    tags:
      - observability
      - monitoring
      - phoenix
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    routes:
      - name: phoenix-route
        paths:
          - /phoenix
        strip_path: true
        preserve_host: false
        protocols:
          - http
          - https
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        tags:
          - observability

  # Ollama LLM Server
  - name: ollama
    url: http://host.docker.internal:11434
    tags:
      - llm
      - ollama
      - ai
    connect_timeout: 120000
    write_timeout: 120000
    read_timeout: 120000
    routes:
      - name: ollama-route
        paths:
          - /ollama
        strip_path: true
        preserve_host: false
        protocols:
          - http
          - https
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        tags:
          - llm
        plugins:
          - name: opentelemetry
            config:
              endpoint: http://host.docker.internal:6006/v1/traces
              resource_attributes:
                service.name: kong-gateway-ollama
                service.version: "1.0.0"
              headers:
                x-phoenix-project-name: kong-ollama-telemetry

# Global plugins for all services
plugins:
  # CORS plugin for cross-origin requests
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - X-Auth-Token
        - Authorization
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600
      preflight_continue: false

  # Request logging for debugging and monitoring
  - name: file-log
    config:
      path: /tmp/kong-requests.log
      reopen: true

  # Rate limiting to prevent abuse
  - name: rate-limiting
    config:
      second: 1000
      minute: 5000
      hour: 100000
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # Prometheus metrics export
  - name: prometheus
    config:
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

# Upstreams for advanced load balancing and health checks
upstreams:
  - name: py-calculator-upstream
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    hash_on_cookie_path: /
    slots: 10000
    healthchecks:
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 5
      active:
        type: http
        timeout: 5
        concurrency: 10
        http_path: /health
        https_verify_certificate: false
        healthy:
          interval: 30
          http_statuses:
            - 200
            - 201
            - 202
            - 204
          successes: 2
        unhealthy:
          interval: 30
          http_statuses:
            - 429
            - 500
            - 503
          timeouts: 3
          http_failures: 3
    targets:
      - target: host.docker.internal:8100
        weight: 100

  - name: go-calculator-upstream
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    hash_on_cookie_path: /
    slots: 10000
    healthchecks:
      passive:
        healthy:
          successes: 5
        unhealthy:
          http_failures: 5
          timeouts: 5
      active:
        type: http
        timeout: 5
        concurrency: 10
        http_path: /health
        https_verify_certificate: false
        healthy:
          interval: 30
          http_statuses:
            - 200
            - 201
            - 202
            - 204
          successes: 2
        unhealthy:
          interval: 30
          http_statuses:
            - 429
            - 500
            - 503
          timeouts: 3
          http_failures: 3
    targets:
      - target: host.docker.internal:8200
        weight: 100
